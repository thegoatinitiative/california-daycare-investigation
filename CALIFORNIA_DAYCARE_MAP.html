<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California High-Risk Daycare Facilities Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

        #header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        #header h1 { font-size: 1.5em; font-weight: 600; }
        #header .subtitle { font-size: 0.85em; opacity: 0.8; margin-top: 3px; }

        #stats {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
        }

        .stat {
            text-align: center;
            padding: 5px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        .stat-value { font-size: 1.3em; font-weight: bold; }
        .stat-label { font-size: 0.75em; opacity: 0.8; }

        #map { height: calc(100vh - 130px); width: 100%; }

        #controls {
            background: white;
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label { font-size: 0.85em; font-weight: 500; color: #444; }

        select, input[type="range"] {
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-left: auto;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8em;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.2em;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .leaflet-popup-content { max-width: 300px; }
        .popup-title {
            font-size: 1em;
            margin-bottom: 8px;
            color: #1a1a2e;
            border-bottom: 2px solid #e94560;
            padding-bottom: 5px;
            font-weight: bold;
        }
        .popup-detail {
            font-size: 0.85em;
            margin: 4px 0;
            color: #444;
        }
        .popup-links {
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        .popup-links a {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background: #1a1a2e;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-size: 0.75em;
        }
        .popup-links a:hover { background: #e94560; }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        Loading facility data...
    </div>

    <div id="header">
        <div>
            <h1>California High-Risk Daycare Facilities</h1>
            <div class="subtitle">Fraud Pattern Analysis - Data from CA Community Care Licensing</div>
        </div>
        <div id="stats">
            <div class="stat">
                <div class="stat-value" id="total-count">0</div>
                <div class="stat-label">Facilities Shown</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="high-risk-count">0</div>
                <div class="stat-label">High Risk (7+)</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="closed-count">0</div>
                <div class="stat-label">Closed</div>
            </div>
        </div>
    </div>

    <div id="controls">
        <div class="control-group">
            <label>Min Risk Score:</label>
            <select id="risk-filter">
                <option value="0">All (0+)</option>
                <option value="3">3+</option>
                <option value="5" selected>5+ (High Risk)</option>
                <option value="7">7+ (Very High)</option>
                <option value="9">9+ (Critical)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Status:</label>
            <select id="status-filter">
                <option value="all">All</option>
                <option value="CLOSED">Closed Only</option>
                <option value="LICENSED">Licensed Only</option>
            </select>
        </div>

        <div class="control-group">
            <label>City:</label>
            <select id="city-filter">
                <option value="all">All Cities</option>
            </select>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot" style="background: #ff0000;"></div>
                <span>Risk 9-10</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #ff6600;"></div>
                <span>Risk 7-8</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #ffaa00;"></div>
                <span>Risk 5-6</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #88cc00;"></div>
                <span>Risk 3-4</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #00aa44;"></div>
                <span>Risk 0-2</span>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // Initialize map centered on California
        const map = L.map('map').setView([36.7783, -119.4179], 6);

        // Add tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Store markers and data
        let allFacilities = [];
        let markers = L.layerGroup().addTo(map);

        // Color scale based on risk score
        function getColor(risk) {
            if (risk >= 9) return '#ff0000';
            if (risk >= 7) return '#ff6600';
            if (risk >= 5) return '#ffaa00';
            if (risk >= 3) return '#88cc00';
            return '#00aa44';
        }

        // Get marker size based on risk
        function getRadius(risk) {
            return Math.max(5, Math.min(12, 4 + risk));
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.textContent;
        }

        // Create popup content safely
        function createPopupElement(f) {
            const container = document.createElement('div');
            container.style.maxWidth = '300px';

            // Title
            const title = document.createElement('div');
            title.className = 'popup-title';
            title.textContent = f.name + ' (Risk: ' + f.risk_score + ')';
            container.appendChild(title);

            // Details
            const details = [
                ['Licensee', f.licensee],
                ['Address', f.address + ', ' + f.city + ' ' + f.zip],
                ['Capacity', f.capacity + ' children'],
                ['Status', f.status],
                ['Licensed', f.license_date || 'N/A']
            ];

            if (f.status === 'CLOSED' && f.closed_date) {
                details.push(['Closed', f.closed_date]);
            }

            details.forEach(([label, value]) => {
                const div = document.createElement('div');
                div.className = 'popup-detail';
                const strong = document.createElement('strong');
                strong.textContent = label + ': ';
                div.appendChild(strong);
                div.appendChild(document.createTextNode(value));
                container.appendChild(div);
            });

            // Links
            const links = document.createElement('div');
            links.className = 'popup-links';

            const mapsLink = document.createElement('a');
            mapsLink.href = 'https://www.google.com/maps/search/' + encodeURIComponent(f.address + ', ' + f.city + ', CA');
            mapsLink.target = '_blank';
            mapsLink.textContent = 'Google Maps';
            links.appendChild(mapsLink);

            const sosLink = document.createElement('a');
            sosLink.href = 'https://bizfileonline.sos.ca.gov/search/business?searchType=Business+Name&searchCriteria=' + encodeURIComponent(f.licensee.replace(/ LLC| INC| CORP/gi, ''));
            sosLink.target = '_blank';
            sosLink.textContent = 'CA SOS';
            links.appendChild(sosLink);

            const newsLink = document.createElement('a');
            newsLink.href = 'https://www.google.com/search?q=' + encodeURIComponent('"' + f.name + '" ' + f.city + ' California daycare') + '&tbm=nws';
            newsLink.target = '_blank';
            newsLink.textContent = 'News';
            links.appendChild(newsLink);

            container.appendChild(links);

            return container;
        }

        // Update markers based on filters
        function updateMarkers() {
            markers.clearLayers();

            const minRisk = parseInt(document.getElementById('risk-filter').value);
            const statusFilter = document.getElementById('status-filter').value;
            const cityFilter = document.getElementById('city-filter').value;

            let shown = 0;
            let highRisk = 0;
            let closed = 0;

            allFacilities.forEach(f => {
                // Apply filters
                if (f.risk_score < minRisk) return;
                if (statusFilter !== 'all' && f.status !== statusFilter) return;
                if (cityFilter !== 'all' && f.city !== cityFilter) return;

                shown++;
                if (f.risk_score >= 7) highRisk++;
                if (f.status === 'CLOSED') closed++;

                const marker = L.circleMarker([f.lat, f.lng], {
                    radius: getRadius(f.risk_score),
                    fillColor: getColor(f.risk_score),
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.bindPopup(createPopupElement(f));
                markers.addLayer(marker);
            });

            // Update stats
            document.getElementById('total-count').textContent = shown.toLocaleString();
            document.getElementById('high-risk-count').textContent = highRisk.toLocaleString();
            document.getElementById('closed-count').textContent = closed.toLocaleString();
        }

        // Populate city filter
        function populateCityFilter() {
            const cities = [...new Set(allFacilities.map(f => f.city))].filter(c => c && c !== 'nan').sort();
            const select = document.getElementById('city-filter');
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
        }

        // Load data
        fetch('facilities_map_data.json')
            .then(response => response.json())
            .then(data => {
                allFacilities = data;
                populateCityFilter();
                updateMarkers();
                document.getElementById('loading').style.display = 'none';
            })
            .catch(error => {
                console.error('Error loading data:', error);
                const loading = document.getElementById('loading');
                loading.textContent = 'Error loading data. Make sure facilities_map_data.json is in the same folder.';
            });

        // Event listeners for filters
        document.getElementById('risk-filter').addEventListener('change', updateMarkers);
        document.getElementById('status-filter').addEventListener('change', updateMarkers);
        document.getElementById('city-filter').addEventListener('change', updateMarkers);
    </script>
</body>
</html>
